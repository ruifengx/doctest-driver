<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Description: DocTest extraction using the GHC API.</span><span>
</span><span id="line-2"></span><span class="hs-comment">-- Copyright: Copyright 2024, Ruifeng Xie</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- License: AGPL-3.0-or-later</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- Maintainer: Ruifeng Xie &lt;ruifengx@outlook.com&gt;</span><span>
</span><span id="line-5"></span><span class="hs-comment">--</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- DocTest extraction using the GHC API. GHC environment and options are handled here.</span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Test.DocTest.Driver.Extract.GHC</span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Test.DocTest.Driver.Extract.GHC.html#parseModulesIn"><span class="hs-identifier">parseModulesIn</span></a></span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Test.DocTest.Driver.Extract.GHC.html#parseModules"><span class="hs-identifier">parseModules</span></a></span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forM</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unless</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isSuffixOf</span></span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Directory</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">doesDirectoryExist</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">listDirectory</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.FilePath</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&lt;/&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC</span></span><span> </span><span class="hs-keyword">qualified</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Paths</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GHC</span></span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Ghc</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Data.Graph.Directed</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">flattenSCCs</span></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Driver.Session</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">DynFlags</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">backend</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ghcLink</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ghcMode</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">gopt_set</span></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Unit.Module.Graph</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">filterToposortToModules</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Utils.Panic</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">GhcException</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">UsageError</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">throwGhcException</span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="annot"><span class="hs-comment">-- | Parse all the files in all the directories in the given list.</span></span><span>
</span><span id="line-27"></span><span class="annot"><a href="Test.DocTest.Driver.Extract.GHC.html#parseModulesIn"><span class="hs-identifier hs-type">parseModulesIn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">GHC.ParsedModule</span></span><span class="hs-special">]</span><span>
</span><span id="line-28"></span><span id="parseModulesIn"><span class="annot"><span class="annottext">parseModulesIn :: [String] -&gt; [String] -&gt; IO [ParsedModule]
</span><a href="Test.DocTest.Driver.Extract.GHC.html#parseModulesIn"><span class="hs-identifier hs-var hs-var">parseModulesIn</span></a></span></span><span> </span><span id="local-6989586621679158982"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679158982"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621679158983"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679158983"><span class="hs-identifier hs-var">dirs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-29"></span><span>  </span><span id="local-6989586621679158984"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679158984"><span class="hs-identifier hs-var">paths</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[[String]] -&gt; [String]
forall (t :: Type -&gt; Type) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[String]] -&gt; [String]) -&gt; IO [[String]] -&gt; IO [String]
forall (f :: Type -&gt; Type) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO [String]) -&gt; [String] -&gt; IO [[String]]
forall (t :: Type -&gt; Type) (f :: Type -&gt; Type) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: Type -&gt; Type) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO [String]
</span><a href="Test.DocTest.Driver.Extract.GHC.html#recursiveListDirectory"><span class="hs-identifier hs-var">recursiveListDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679158983"><span class="hs-identifier hs-var">dirs</span></a></span><span>
</span><span id="line-30"></span><span>  </span><span class="annot"><span class="annottext">[String] -&gt; [String] -&gt; IO [ParsedModule]
</span><a href="Test.DocTest.Driver.Extract.GHC.html#parseModules"><span class="hs-identifier hs-var">parseModules</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679158982"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; Bool) -&gt; [String] -&gt; [String]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.hs&quot;</span></span><span> </span><span class="hs-special">`</span><span class="hs-identifier">isSuffixOf</span><span class="hs-special">`</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679158984"><span class="hs-identifier hs-var">paths</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="annot"><span class="hs-comment">-- | Parse all the files in the given list.</span></span><span>
</span><span id="line-33"></span><span class="annot"><a href="Test.DocTest.Driver.Extract.GHC.html#parseModules"><span class="hs-identifier hs-type">parseModules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">GHC.ParsedModule</span></span><span class="hs-special">]</span><span>
</span><span id="line-34"></span><span id="parseModules"><span class="annot"><span class="annottext">parseModules :: [String] -&gt; [String] -&gt; IO [ParsedModule]
</span><a href="Test.DocTest.Driver.Extract.GHC.html#parseModules"><span class="hs-identifier hs-var hs-var">parseModules</span></a></span></span><span> </span><span id="local-6989586621679158989"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679158989"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621679158990"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679158990"><span class="hs-identifier hs-var">paths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe String -&gt; Ghc [ParsedModule] -&gt; IO [ParsedModule]
forall a. Maybe String -&gt; Ghc a -&gt; IO a
</span><span class="hs-identifier hs-var">GHC.runGhc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier hs-var">GHC.libdir</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-35"></span><span>  </span><span class="annot"><span class="annottext">[String] -&gt; Ghc ()
</span><a href="Test.DocTest.Driver.Extract.GHC.html#handleOptions"><span class="hs-identifier hs-var">handleOptions</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679158989"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-36"></span><span>  </span><span id="local-6989586621679158994"><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621679158994"><span class="hs-identifier hs-var">targets</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(String -&gt; Ghc Target) -&gt; [String] -&gt; Ghc [Target]
forall (t :: Type -&gt; Type) (m :: Type -&gt; Type) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: Type -&gt; Type) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679158996"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679158996"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe UnitId -&gt; Maybe Phase -&gt; Ghc Target
forall (m :: Type -&gt; Type).
GhcMonad m =&gt;
String -&gt; Maybe UnitId -&gt; Maybe Phase -&gt; m Target
</span><span class="hs-identifier hs-var">GHC.guessTarget</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679158996"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UnitId
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe Phase
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679158990"><span class="hs-identifier hs-var">paths</span></a></span><span>
</span><span id="line-37"></span><span>  </span><span class="annot"><span class="annottext">[Target] -&gt; Ghc ()
forall (m :: Type -&gt; Type). GhcMonad m =&gt; [Target] -&gt; m ()
</span><span class="hs-identifier hs-var">GHC.setTargets</span></span><span> </span><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621679158994"><span class="hs-identifier hs-var">targets</span></a></span><span>
</span><span id="line-38"></span><span>  </span><span id="local-6989586621679158999"><span class="annot"><span class="annottext">[ModSummary]
</span><a href="#local-6989586621679158999"><span class="hs-identifier hs-var">modules</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SCC ModSummary] -&gt; [ModSummary]
forall a. [SCC a] -&gt; [a]
</span><span class="hs-identifier hs-var">flattenSCCs</span></span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><span class="annottext">([SCC ModSummary] -&gt; [ModSummary])
-&gt; (ModuleGraph -&gt; [SCC ModSummary]) -&gt; ModuleGraph -&gt; [ModSummary]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[SCC ModuleGraphNode] -&gt; [SCC ModSummary]
</span><span class="hs-identifier hs-var">filterToposortToModules</span></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><span class="annottext">([SCC ModuleGraphNode] -&gt; [SCC ModSummary])
-&gt; (ModuleGraph -&gt; [SCC ModuleGraphNode])
-&gt; ModuleGraph
-&gt; [SCC ModSummary]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ModuleGraph -&gt; Maybe HomeUnitModule -&gt; [SCC ModuleGraphNode])
-&gt; Maybe HomeUnitModule -&gt; ModuleGraph -&gt; [SCC ModuleGraphNode]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
-&gt; ModuleGraph -&gt; Maybe HomeUnitModule -&gt; [SCC ModuleGraphNode]
</span><span class="hs-identifier hs-var">GHC.topSortModuleGraph</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe HomeUnitModule
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><span class="annottext">(ModuleGraph -&gt; [ModSummary])
-&gt; Ghc ModuleGraph -&gt; Ghc [ModSummary]
forall (f :: Type -&gt; Type) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[ModuleName] -&gt; Bool -&gt; Ghc ModuleGraph
forall (m :: Type -&gt; Type).
GhcMonad m =&gt;
[ModuleName] -&gt; Bool -&gt; m ModuleGraph
</span><span class="hs-identifier hs-var">GHC.depanal</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><span class="annottext">(ModSummary -&gt; Ghc ParsedModule)
-&gt; [ModSummary] -&gt; Ghc [ParsedModule]
forall (t :: Type -&gt; Type) (m :: Type -&gt; Type) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: Type -&gt; Type) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">ModSummary -&gt; Ghc ParsedModule
forall (m :: Type -&gt; Type).
GhcMonad m =&gt;
ModSummary -&gt; m ParsedModule
</span><span class="hs-identifier hs-var">GHC.parseModule</span></span><span> </span><span class="annot"><span class="annottext">[ModSummary]
</span><a href="#local-6989586621679158999"><span class="hs-identifier hs-var">modules</span></a></span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="annot"><a href="Test.DocTest.Driver.Extract.GHC.html#handleOptions"><span class="hs-identifier hs-type">handleOptions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ghc</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span id="handleOptions"><span class="annot"><span class="annottext">handleOptions :: [String] -&gt; Ghc ()
</span><a href="Test.DocTest.Driver.Extract.GHC.html#handleOptions"><span class="hs-identifier hs-var hs-var">handleOptions</span></a></span></span><span> </span><span id="local-6989586621679159005"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679159005"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-46"></span><span>  </span><span id="local-6989586621679159006"><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621679159006"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ghc Logger
forall (m :: Type -&gt; Type). HasLogger m =&gt; m Logger
</span><span class="hs-identifier hs-var">GHC.getLogger</span></span><span>
</span><span id="line-47"></span><span>  </span><span id="local-6989586621679159008"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621679159008"><span class="hs-identifier hs-var">flags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; DynFlags
</span><a href="Test.DocTest.Driver.Extract.GHC.html#setFlags"><span class="hs-identifier hs-var">setFlags</span></a></span><span> </span><span class="annot"><span class="annottext">(DynFlags -&gt; DynFlags) -&gt; Ghc DynFlags -&gt; Ghc DynFlags
forall (f :: Type -&gt; Type) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Ghc DynFlags
forall (m :: Type -&gt; Type). GhcMonad m =&gt; m DynFlags
</span><span class="hs-identifier hs-var">GHC.getSessionDynFlags</span></span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679159011"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621679159011"><span class="hs-identifier hs-var">flags'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679159012"><span class="annot"><span class="annottext">[Located String]
</span><a href="#local-6989586621679159012"><span class="hs-identifier hs-var">unknown</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679159013"><span class="annot"><span class="annottext">[Warn]
</span><a href="#local-6989586621679159013"><span class="hs-identifier hs-var">_warnings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Logger
-&gt; DynFlags
-&gt; [Located String]
-&gt; Ghc (DynFlags, [Located String], [Warn])
forall (m :: Type -&gt; Type).
MonadIO m =&gt;
Logger
-&gt; DynFlags
-&gt; [Located String]
-&gt; m (DynFlags, [Located String], [Warn])
</span><span class="hs-identifier hs-var">GHC.parseDynamicFlags</span></span><span> </span><span class="annot"><span class="annottext">Logger
</span><a href="#local-6989586621679159006"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621679159008"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; Located String) -&gt; [String] -&gt; [Located String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Located String
forall e. e -&gt; Located e
</span><span class="hs-identifier hs-var">GHC.noLoc</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679159005"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Ghc () -&gt; Ghc ()
forall (f :: Type -&gt; Type). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Located String] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: Type -&gt; Type) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Located String]
</span><a href="#local-6989586621679159012"><span class="hs-identifier hs-var">unknown</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679159017"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621679159017"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unknown flags: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Located String -&gt; String) -&gt; [Located String] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Located String -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[Located String]
</span><a href="#local-6989586621679159012"><span class="hs-identifier hs-var">unknown</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><span class="annottext">GhcException -&gt; Ghc ()
forall a. GhcException -&gt; a
</span><span class="hs-identifier hs-var">throwGhcException</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; GhcException
</span><span class="hs-identifier hs-var">UsageError</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679159017"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><span class="annottext">DynFlags -&gt; Ghc ()
forall (m :: Type -&gt; Type).
(HasCallStack, GhcMonad m) =&gt;
DynFlags -&gt; m ()
</span><span class="hs-identifier hs-var">GHC.setSessionDynFlags</span></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621679159011"><span class="hs-identifier hs-var">flags'</span></a></span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="annot"><a href="Test.DocTest.Driver.Extract.GHC.html#setFlags"><span class="hs-identifier hs-type">setFlags</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DynFlags</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DynFlags</span></span><span>
</span><span id="line-55"></span><span id="setFlags"><span class="annot"><span class="annottext">setFlags :: DynFlags -&gt; DynFlags
</span><a href="Test.DocTest.Driver.Extract.GHC.html#setFlags"><span class="hs-identifier hs-var hs-var">setFlags</span></a></span></span><span> </span><span id="local-6989586621679159021"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621679159021"><span class="hs-identifier hs-var">flags</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; GeneralFlag -&gt; DynFlags
</span><span class="hs-identifier hs-var">gopt_set</span></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621679159021"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><span class="hs-identifier hs-var">GHC.Opt_Haddock</span></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-var">backend</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GHC.noBackend</span></span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-var">ghcMode</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GHC.CompManager</span></span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-var">ghcLink</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">GHC.NoLink</span></span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span class="annot"><a href="Test.DocTest.Driver.Extract.GHC.html#recursiveListDirectory"><span class="hs-identifier hs-type">recursiveListDirectory</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">]</span><span>
</span><span id="line-62"></span><span id="recursiveListDirectory"><span class="annot"><span class="annottext">recursiveListDirectory :: String -&gt; IO [String]
</span><a href="Test.DocTest.Driver.Extract.GHC.html#recursiveListDirectory"><span class="hs-identifier hs-var hs-var">recursiveListDirectory</span></a></span></span><span> </span><span id="local-6989586621679159026"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679159026"><span class="hs-identifier hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-63"></span><span>  </span><span id="local-6989586621679159027"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679159027"><span class="hs-identifier hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(String -&gt; String) -&gt; [String] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679159026"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="hs-operator">&lt;/&gt;</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([String] -&gt; [String]) -&gt; IO [String] -&gt; IO [String]
forall (f :: Type -&gt; Type) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO [String]
</span><span class="hs-identifier hs-var">listDirectory</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679159026"><span class="hs-identifier hs-var">dir</span></a></span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><span class="annottext">[[String]] -&gt; [String]
forall (t :: Type -&gt; Type) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[String]] -&gt; [String]) -&gt; IO [[String]] -&gt; IO [String]
forall (f :: Type -&gt; Type) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; (String -&gt; IO [String]) -&gt; IO [[String]]
forall (t :: Type -&gt; Type) (m :: Type -&gt; Type) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679159027"><span class="hs-identifier hs-var">children</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159028"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679159028"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-65"></span><span>    </span><span id="local-6989586621679159029"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679159029"><span class="hs-identifier hs-var">isDir</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO Bool
</span><span class="hs-identifier hs-var">doesDirectoryExist</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679159028"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679159029"><span class="hs-identifier hs-var">isDir</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO [String]
</span><a href="Test.DocTest.Driver.Extract.GHC.html#recursiveListDirectory"><span class="hs-identifier hs-var">recursiveListDirectory</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679159028"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; IO [String]
forall a. a -&gt; IO a
forall (f :: Type -&gt; Type) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679159028"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-67"></span></pre></body></html>